<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rewired Studio Monitor</title>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --accent: #007aff; --text: #ffffff; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { background: var(--card); padding: 30px; border-radius: 24px; text-align: center; width: 85%; max-width: 360px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid #333; }
        h1 { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 5px; margin-left: 4px; text-transform: uppercase; }
        input { width: 100%; padding: 12px; background: #222; border: 1px solid #333; border-radius: 10px; color: white; font-size: 1rem; box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--accent); }

        .meter-stack { display: flex; gap: 4px; justify-content: center; height: 120px; margin: 20px 0; }
        .meter { width: 12px; background: #222; border-radius: 4px; position: relative; overflow: hidden; }
        .meter-fill { width: 100%; position: absolute; bottom: 0; background: linear-gradient(to top, #34c759 0%, #34c759 70%, #ffcc00 85%, #ff3b30 100%); transition: height 0.08s ease-out; }

        .status { font-size: 0.85rem; margin-bottom: 20px; color: #666; }
        .status.online { color: #34c759; }

        button { background: var(--accent); color: white; border: none; padding: 16px; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; -webkit-tap-highlight-color: transparent; }
        button:disabled { background: #333; color: #666; }
    </style>
</head>
<body>

<div class="container" id="setup-view">
    <h1>Studio Monitor</h1>
    
    <div class="input-group">
        <label>Room Name</label>
        <input type="text" id="room-input" placeholder="studio1" value="studio1">
    </div>
    
    <div class="input-group">
        <label>Your Name</label>
        <input type="text" id="name-input" placeholder="Enter name...">
    </div>

    <div id="meter-display" class="meter-stack" style="display:none;">
        <div class="meter"><div id="fill-l" class="meter-fill" style="height: 0%"></div></div>
        <div class="meter"><div id="fill-r" class="meter-fill" style="height: 0%"></div></div>
    </div>

    <div id="status" class="status">Enter details to join</div>
    <button id="join-btn">Listen Live</button>
</div>

<audio id="remote-audio" autoplay playsinline></audio>

<script>
    const serverUrl = window.location.origin.replace(/^http/, 'ws');
    const myId = crypto.randomUUID();

    let socket, pc, audioCtx;

    const joinBtn = document.getElementById('join-btn');
    const roomInput = document.getElementById('room-input');
    const nameInput = document.getElementById('name-input');
    const statusLabel = document.getElementById('status');
    const meterDisplay = document.getElementById('meter-display');
    const fillL = document.getElementById('fill-l');
    const fillR = document.getElementById('fill-r');

    joinBtn.addEventListener('click', async () => {
        const roomName = roomInput.value.trim();
        const userName = nameInput.value.trim();

        if (!roomName || !userName) {
            statusLabel.innerText = "Room and Name required!";
            statusLabel.style.color = "#ff3b30";
            return;
        }

        joinBtn.disabled = true;
        roomInput.disabled = true;
        nameInput.disabled = true;
        statusLabel.style.color = "#666";
        statusLabel.innerText = "Initializing Audio...";
        
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            initSignaling(roomName, userName);
        } catch (e) {
            statusLabel.innerText = "Error: " + e.message;
            joinBtn.disabled = false;
        }
    });

    function initSignaling(room, name) {
        socket = new WebSocket(serverUrl);

        socket.onopen = () => {
            statusLabel.innerText = `Joining ${room}...`;
            statusLabel.classList.add('online');
            
            socket.send(JSON.stringify({
                type: "join",
                room: room,
                name: name,
                id: myId,
                role: "receiver"
            }));
        };

        socket.onmessage = async (event) => {
            const msg = JSON.parse(event.data);
            if (msg.id === myId) return;

            switch (msg.type) {
                case "offer":
                    handleOffer(msg.sdp, msg.id);
                    break;
                case "candidate":
                    if (pc) await pc.addIceCandidate(new RTCIceCandidate({
                        candidate: msg.candidate,
                        sdpMLineIndex: msg.sdpMLineIndex,
                        sdpMid: msg.sdpMid
                    }));
                    break;
            }
        };
    }

    async function handleOffer(sdp, senderId) {
        pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        pc.onicecandidate = (e) => {
            if (e.candidate) {
                socket.send(JSON.stringify({
                    type: "candidate",
                    candidate: e.candidate.candidate,
                    sdpMLineIndex: e.candidate.sdpMLineIndex,
                    sdpMid: e.candidate.sdpMid,
                    id: myId,
                    targetId: senderId
                }));
            }
        };

        pc.ontrack = (event) => {
            statusLabel.innerText = "Live Stream Active";
            meterDisplay.style.display = "flex";
            const stream = event.streams[0];
            document.getElementById('remote-audio').srcObject = stream;
            setupMetering(stream);
        };

        await pc.setRemoteDescription(new RTCSessionDescription({ type: "offer", sdp: sdp }));
        const answer = await pc.createAnswer();
        
        // Munge SDP for high quality stereo [cite: 359]
        answer.sdp = answer.sdp.replace("useinbandfec=1", "useinbandfec=1;stereo=1;sprop-stereo=1;maxaveragebitrate=510000");
        
        await pc.setLocalDescription(answer);
        socket.send(JSON.stringify({ type: "answer", sdp: answer.sdp, id: myId, targetId: senderId }));
    }

    function setupMetering(stream) {
        const source = audioCtx.createMediaStreamSource(stream);
        const splitter = audioCtx.createChannelSplitter(2);
        source.connect(splitter);

        const analyze = (idx, el) => {
            const proc = audioCtx.createAnalyser();
            proc.fftSize = 256;
            splitter.connect(proc, idx);
            const data = new Uint8Array(proc.frequencyBinCount);
            const draw = () => {
                proc.getByteFrequencyData(data);
                const avg = data.reduce((a, b) => a + b) / data.length;
                const boosted = Math.min(Math.sqrt(avg / 255) * 100, 100);
                el.style.height = boosted + "%";
                requestAnimationFrame(draw);
            };
            draw();
        };
        analyze(0, fillL);
        analyze(1, fillR);
    }
</script>
</body>
</html>
