<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rewired Studio Monitor</title>
    <style>
        :root {
            --bg: #000000; 
            --card: #1c1c1e; --accent: #0a84ff; [cite: 329]
            --text: #f2f2f7; --danger: #ff453a; [cite: 329]
            --success: #32d74b; [cite: 329]
            --success-light: #66ff7f; [cite: 330]
            --warn: #ff9f0a; [cite: 331]
            --ice: #bd53ed; --sig: #8e8e93; [cite: 332]
            --vol: #00ffcc; [cite: 333]
        }
        body {
            font-family: -apple-system, system-ui; [cite: 333]
            background: var(--bg); color: var(--text); [cite: 334]
            display: flex; flex-direction: column; align-items: center; justify-content: center; [cite: 334]
            min-height: 100vh; margin: 0; padding: 16px; box-sizing: border-box; [cite: 334]
            overflow-x: hidden; [cite: 335]
        }
        .container {
            background: var(--card); [cite: 335]
            padding: 24px 20px; border-radius: 20px; [cite: 336]
            width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 24px; [cite: 336]
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); [cite: 336]
            position: relative; [cite: 337]
        }
        
        .header { text-align: center; [cite: 337]
            border-bottom: 1px solid #333; padding-bottom: 15px; position: relative; } [cite: 338]
        h1 { margin: 0; [cite: 338]
            font-size: 0.9rem; font-weight: 700; text-transform: uppercase; color: #8e8e93; margin-bottom: 8px; [cite: 339]
        }
        .status-row { display: flex; align-items: center; justify-content: center; height: 16px; [cite: 340]
        }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; margin-right: 8px; [cite: 341]
        }
        .status-dot.on { background: var(--success); box-shadow: 0 0 8px var(--success); [cite: 342]
        }
        .status-text { font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; [cite: 343]
        }
        
        #btn-talk {
            position: absolute; [cite: 344]
            right: 0; top: 0; width: 32px; height: 32px; [cite: 345]
            background: #2c2c2e; border-radius: 50%; border: 1px solid #333; [cite: 345]
            display: none; align-items: center; [cite: 345]
            justify-content: center; cursor: pointer; [cite: 346]
            z-index: 10; transition: all 0.2s; color: #666; [cite: 346]
        }
        #btn-talk.active { background: var(--accent); border-color: var(--accent); color: white; [cite: 347]
        }
        #btn-talk.repair { background: var(--warn); border-color: var(--warn); color: black; animation: pulse 1s infinite; [cite: 348]
        }
        #btn-talk svg { width: 16px; height: 16px; fill: currentColor; [cite: 349]
        }
        
        @keyframes pulse { 0% { opacity: 1; [cite: 350]
        } 50% { opacity: 0.5; } 100% { opacity: 1; [cite: 351]
        } }

        .input-group { display: flex; [cite: 352]
            gap: 10px; width: 100%; } [cite: 353]
        input { flex: 1; background: #2c2c2e; border: none; [cite: 353]
            color: white; padding: 14px; border-radius: 12px; text-align: center; font-size: 15px; outline: none; min-width: 0; [cite: 354]
        }
        .controls-row { display: flex; gap: 12px; width: 100%; [cite: 355]
        }
        
        button { border: none; [cite: 356]
            border-radius: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; } [cite: 357]
        #btn-main { flex: 1; [cite: 357]
            background: var(--accent); color: white; height: 56px; font-size: 1rem; } [cite: 358]
        #btn-main.disconnect { background: var(--danger); [cite: 358]
        }
        
        #btn-mute { width: 56px; [cite: 359]
            height: 56px; background: #2c2c2e; color: #8e8e93; display: none; align-items: center; justify-content: center; [cite: 360]
        }
        #btn-mute.active { background: var(--accent); color: white; [cite: 361]
        }
        #btn-mute svg { width: 24px; height: 24px; fill: currentColor; [cite: 362]
        }

        #roster-panel { display: none; [cite: 363]
            flex-direction: column; gap: 8px; border-top: 1px solid #333; padding-top: 15px; [cite: 364]
        }
        .roster-header { font-size: 0.9rem; color: #8e8e93; font-weight: 700; text-align: center; margin-bottom: 8px; [cite: 365]
        }
        .roster-item { display: flex; align-items: center; justify-content: space-between; background: #252527; [cite: 366]
            padding: 10px 12px; border-radius: 10px; } [cite: 367]
        .roster-left { display: flex; align-items: center; [cite: 367]
            gap: 10px; } [cite: 368]
        
        .role-icon { width: 18px; [cite: 374]
            height: 18px; color: #555; transition: color 0.3s ease; display: flex; align-items: center; [cite: 375]
        }
        .role-icon svg { width: 100%; height: 100%; fill: currentColor; [cite: 376]
        } 
        
        .role-icon.sender { color: var(--accent); [cite: 377]
        } 
        .role-icon.recv-unmuted { color: var(--success); [cite: 378]
        } 
        .role-icon.recv-muted { color: var(--warn); [cite: 379]
        } 
        .role-icon.connecting { color: var(--warn); animation: pulse 1s infinite; [cite: 380]
        }
        .role-icon.failed { color: var(--danger); [cite: 381]
        }

        .roster-name { font-size: 0.9rem; font-weight: 500; color: #eee; [cite: 382]
        }
        
        .roster-status { width: 16px; [cite: 383]
            height: 16px; transition: color 0.15s ease-out; display: flex; align-items: center; [cite: 384]
        }
        .roster-status svg { width: 100%; height: 100%; fill: currentColor; [cite: 385]
        } 
        
        .roster-status.muted { color: var(--warn); [cite: 386]
        }
        .roster-status.unmuted { color: var(--success); [cite: 387]
        }
        .roster-status.signal {
            color: var(--success-light); [cite: 388]
            filter: drop-shadow(0 0 5px var(--success)); [cite: 389]
            transform: scale(1.1); [cite: 389]
        }

        .mini-meters { display: none; [cite: 389]
            gap: 2px; margin-left: 10px; height: 10px; align-items: flex-end; } [cite: 390]
        .mini-meter-col { width: 4px; [cite: 390]
            height: 100%; background: #333; border-radius: 1px; position: relative; overflow: hidden; [cite: 391]
        }
        .mini-meter-fill { width: 100%; position: absolute; bottom: 0; background: var(--success); height: 0%; [cite: 392]
        }
        .bitrate { font-family: monospace; font-size: 0.7rem; color: #666; margin-top: 4px; [cite: 393]
        }
        
        #console { height: 150px; [cite: 394]
            background: #000; border-radius: 8px; border: 1px solid #333; padding: 10px; font-family: monospace; font-size: 9px; color: #636366; overflow-y: auto; width: 100%; [cite: 395]
            box-sizing: border-box; } [cite: 396]
        .log-err { color: var(--danger); } .log-mic { color: #d63aff; [cite: 396]
        } .log-ice { color: var(--ice); } .log-sig { color: var(--sig); } .log-vol { color: var(--vol); } .log-success { color: var(--success); [cite: 397]
            font-weight: bold; } [cite: 398]
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Studio Monitor</h1>
        
        <div id="btn-talk" class="muted">
            <svg id="icon-talk-off" viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg> [cite: 398]
            <svg id="icon-talk-on" viewBox="0 0 24 24" style="display:none;"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg> [cite: 399]
            <svg id="icon-repair" viewBox="0 0 24 24" style="display:none;"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg> [cite: 399]
        </div>

        <div class="status-container">
            <div class="status-row">
                <span id="status-dot" class="status-dot"></span> [cite: 400]
                <span id="status-text" class="status-text">DISCONNECTED</span> [cite: 400]
                <div id="mini-meters" class="mini-meters">
                    <div class="mini-meter-col"><div id="m-l" class="mini-meter-fill"></div></div> [cite: 400]
                    <div class="mini-meter-col"><div id="m-r" class="mini-meter-fill"></div></div> [cite: 400]
                </div>
            </div>
            <div id="bitrate" class="bitrate">0 kbps</div> [cite: 401]
        </div>
    </div>

    <div id="setup-panel" class="input-group">
        <input id="room" value="studio1" placeholder="Room Name"> [cite: 401]
        <input id="user" placeholder="Your Name"> [cite: 401]
    </div>

    <div class="controls-row">
        <button id="btn-main">Listen Live</button> [cite: 401]
        <button id="btn-mute" class="active"> [cite: 402]
            <svg id="icon-vol" viewBox="0 0 24 24"><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zm-4 0h-2.5l-5 5H0v6h2.5l5 5H10V3.23z"/></svg> [cite: 402]
            <svg id="icon-mute" viewBox="0 0 24 24" style="display:none"><path d="M19 12c0 1.72-1.02 3.22-2.5 4v2.15c2.34-.99 4-3.32 4-6.15 0-2.83-1.66-5.16-4-6.15V8c1.48.78 2.5 2.28 2.5 4zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg> [cite: 402]
        </button>
    </div>

    <div id="roster-panel"> [cite: 403]
        <div id="roster-title" class="roster-header">Participants</div> [cite: 403]
        <div id="roster-list"></div> [cite: 403]
    </div>
    
    <div id="console"></div> [cite: 403]
</div>

<audio id="audio-tag" autoplay playsinline style="display:none;"></audio> [cite: 403]
<div id="voice-container"></div> [cite: 403]

<script>
    const WS_URL = window.location.origin.replace(/^http/, 'ws'); [cite: 403]
    const myId = 'rx-' + Math.floor(Math.random() * 10000); [cite: 404]
    
    let ws, audioCtx, analyser; [cite: 404]
    let studioPC; [cite: 404]
    const voicePeerConnections = {}; [cite: 405]
    const initializingPeers = new Set(); [cite: 405]
    
    let isConnected = false, isMuted = false, isTalking = false, needsRepair = false; [cite: 405]
    let localVoiceStream = null; [cite: 406]
    let broadcasterId = null; [cite: 406]
    let animationId, statsInterval; [cite: 406]
    
    const logEl = document.getElementById('console'); [cite: 406]
    const statusText = document.getElementById('status-text'); [cite: 407]
    const statusDot = document.getElementById('status-dot'); [cite: 407]
    const audioEl = document.getElementById('audio-tag'); [cite: 407]
    const btnMain = document.getElementById('btn-main'); [cite: 407]
    const btnMute = document.getElementById('btn-mute'); [cite: 407]
    const btnTalk = document.getElementById('btn-talk'); [cite: 408]
    
    const ICON_MIC = `<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>`; [cite: 408]
    const ICON_HEADPHONES = `<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9v7c0 1.1.9 2 2 2h4v-8H5v-1c0-3.87 3.13-7 7-7s7 3.13 7 7v1h-4v8h4c1.1 0 2-.9 2-2v-7c0-4.97-4.03-9-9-9z"/></svg>`; [cite: 409]

    function log(msg, type='info') {
        const line = document.createElement('div'); [cite: 410]
        line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`; [cite: 411]
        line.className=`log-${type}`; [cite: 411]
        logEl.prepend(line); [cite: 411]
    }

    function monitorAndRouteAudio(stream, label, rosterId) {
        if (!audioCtx) return; [cite: 411]
        try {
            const src = audioCtx.createMediaStreamSource(stream); [cite: 412]
            if (!label.includes("Local")) { [cite: 413]
                const gain = audioCtx.createGain(); [cite: 413]
                gain.gain.value = 1.0; [cite: 414]
                src.connect(gain); [cite: 414]
                gain.connect(audioCtx.destination); [cite: 414]
            }

            const analyzer = audioCtx.createAnalyser(); [cite: 414]
            analyzer.fftSize = 256; [cite: 415]
            src.connect(analyzer); [cite: 415]
            const data = new Uint8Array(analyzer.frequencyBinCount); [cite: 415]
            
            const timer = setInterval(() => {
                if(!stream.active) { clearInterval(timer); return; } [cite: 415]
                analyzer.getByteFrequencyData(data); [cite: 415]
                let sum = 0; for(let i=0; i<data.length; i++) sum += data[i]; [cite: 415]
                const avg = sum / data.length; [cite: 416]
   
                if (rosterId) {
                    const statusIcon = document.getElementById(`status-icon-${rosterId}`); [cite: 416]
                    if (statusIcon) { [cite: 416]
                        if (avg > 25) statusIcon.classList.add('signal'); [cite: 417]
                        else statusIcon.classList.remove('signal'); [cite: 417]
                    }
                }
            }, 100);
        } catch(e) { log(`Route Error: ${e.message}`, "err"); } [cite: 419]
    }

    btnMain.addEventListener('click', async () => {
        if (!isConnected) { [cite: 419]
            const room = document.getElementById('room').value; [cite: 419]
            const user = document.getElementById('user').value; [cite: 419]
            if(!room || !user) return log("Missing info", "err"); [cite: 419]
            
            document.getElementById('roster-title').innerText = room; [cite: 420]
            setUIState('connecting'); [cite: 420]

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive', sampleRate: 48000 }); [cite: 420]
                await audioCtx.resume(); [cite: 420]
                
                audioEl.srcObject = null; [cite: 421]
                audioEl.muted = false; [cite: 421]
                audioEl.play().catch(()=>{}); [cite: 421]

                log("ðŸŽ™ Requesting Mic...", "mic"); [cite: 421]
                try {
                    localVoiceStream = await navigator.mediaDevices.getUserMedia({ [cite: 422]
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } [cite: 422]
                    });
                    localVoiceStream.getAudioTracks().forEach(t => t.enabled = false); [cite: 423]
                    log("ðŸŽ™ Mic Ready (Muted)", "mic"); [cite: 423]
                    monitorAndRouteAudio(localVoiceStream, "Local Mic", myId); [cite: 423]
                } catch(e) {
                    log("ðŸš« Mic Failed: " + e.message, "err"); [cite: 424]
                    localVoiceStream = null; [cite: 425]
                }
                connectSignaling(room, user); [cite: 425]
            } catch(e) {
                log("Setup Failed: " + e.message, "err"); [cite: 426]
                setUIState('disconnected'); [cite: 427]
            }
        } else {
            disconnectAll(); [cite: 427]
        }
    });

    function disconnectAll() {
        if(ws) ws.close(); [cite: 428]
        if(studioPC) studioPC.close(); [cite: 428]
        studioPC = null; [cite: 429]
        for(let id in voicePeerConnections) {
            if(voicePeerConnections[id].pc) voicePeerConnections[id].pc.close(); [cite: 429]
        }
        if(localVoiceStream) localVoiceStream.getTracks().forEach(t => t.stop()); [cite: 430]
        localVoiceStream = null; [cite: 430]
        document.getElementById('voice-container').innerHTML = ''; [cite: 430]
        initializingPeers.clear(); [cite: 430]
        setUIState('disconnected'); [cite: 430]
    }

    btnTalk.addEventListener('click', () => {
        if (needsRepair) { [cite: 431]
            log("[FIX] ðŸ”§ Repairing...", "log-success"); [cite: 431]
            for(let id in voicePeerConnections) {
                const session = voicePeerConnections[id]; [cite: 431]
                if (session.pc.iceConnectionState === 'failed' || session.pc.iceConnectionState === 'disconnected') { [cite: 431]
                    session.pc.restartIce(); [cite: 432]
                    session.pc.createOffer({ iceRestart: true }).then(offer => { [cite: 432]
                        session.pc.setLocalDescription(offer); [cite: 432]
                        ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp, id: myId, targetId: id })); [cite: 433]
                    });
                }
            }
            needsRepair = false; [cite: 433]
            updateButtons(); [cite: 433]
            return;
        }

        if (!localVoiceStream) return log("No Mic Available", "err"); [cite: 434]
        isTalking = !isTalking; [cite: 434]
        localVoiceStream.getAudioTracks().forEach(t => t.enabled = isTalking); [cite: 434]
        log(isTalking ? "ðŸŽ™ Mic LIVE" : "ðŸŽ™ Mic Muted", "mic"); [cite: 435]
        updateButtons(); [cite: 435]
        broadcastStatus(); [cite: 435]
    });

    function updateButtons() {
        btnMute.className = isMuted ? "" : "active"; [cite: 436]
        document.getElementById('icon-vol').style.display = isMuted ? "none" : "block"; [cite: 437]
        document.getElementById('icon-mute').style.display = isMuted ? "block" : "none"; [cite: 437]
        
        const talkIconOff = document.getElementById('icon-talk-off'); [cite: 437]
        const talkIconOn = document.getElementById('icon-talk-on'); [cite: 438]
        const talkIconFix = document.getElementById('icon-repair'); [cite: 438]

        if (needsRepair) {
            btnTalk.className = "repair"; [cite: 438]
            talkIconOff.style.display = "none"; [cite: 439]
            talkIconOn.style.display = "none"; [cite: 439]
            talkIconFix.style.display = "block"; [cite: 439]
        } else {
            btnTalk.className = isTalking ? "active" : "muted"; [cite: 439]
            talkIconFix.style.display = "none"; [cite: 440]
            talkIconOff.style.display = isTalking ? "none" : "block"; [cite: 440]
            talkIconOn.style.display = isTalking ? "block" : "none"; [cite: 440]
        }
    }

    function connectSignaling(room, user) {
        ws = new WebSocket(WS_URL); [cite: 441]
        ws.onopen = () => { [cite: 442]
            log("WS Connected", "sig"); [cite: 442]
            ws.send(JSON.stringify({ type: 'join', room, name: user, id: myId, role: 'receiver', isBroadcasting: false })); [cite: 443]
        };
        ws.onmessage = e => {
            const msg = JSON.parse(e.data); [cite: 444]
            if(msg.type === 'roster-update') handleRoster(msg.roster); [cite: 445]
            if(msg.id === myId) return; [cite: 445]

            const isBroadcaster = (msg.id === broadcasterId); [cite: 445]
            if(isBroadcaster) handleStudioMsg(msg); [cite: 445]
            else handleVoiceMsg(msg); [cite: 445]
        };
        ws.onclose = () => setUIState('disconnected'); [cite: 446]
    }

    function getVoicePC(peerId) {
        if(!voicePeerConnections[peerId]) { [cite: 446]
            const pc = new RTCPeerConnection({ [cite: 446]
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }], [cite: 447]
                iceTransportPolicy: 'all', [cite: 447]
                bundlePolicy: 'max-bundle', [cite: 447]
                iceCandidatePoolSize: 0 [cite: 447]
            });
            pc.addTransceiver('audio', { direction: 'sendrecv' }); [cite: 448]
            if(localVoiceStream) localVoiceStream.getTracks().forEach(t => pc.addTrack(t, localVoiceStream)); [cite: 448]
            pc.ontrack = e => { [cite: 449]
                log(`ðŸ—£ Audio from ${peerId.substring(0,4)}`, "info"); [cite: 449]
                monitorAndRouteAudio(e.streams[0], `Rx ${peerId.substring(0,4)}`, peerId); [cite: 450]
                const aud = document.createElement('audio'); [cite: 450]
                aud.srcObject = e.streams[0]; [cite: 450]
                aud.autoplay = true; [cite: 450]
                aud.playsInline = true; [cite: 450]
                document.getElementById('voice-container').appendChild(aud); [cite: 450]
            };
            pc.onicecandidate = e => { [cite: 451]
                if(e.candidate) { [cite: 451]
                    const ip = e.candidate.candidate.split(' ')[4]; [cite: 451]
                    if(ip.includes(':')) return; [cite: 452]
                    ws.send(JSON.stringify({ type: 'candidate', ...e.candidate.toJSON(), id: myId, targetId: peerId })); [cite: 452]
                }
            };
            pc.oniceconnectionstatechange = () => { [cite: 454]
                const state = pc.iceConnectionState; [cite: 454]
                log(`[ICE] ${peerId.substring(0,4)} State: ${state}`, state==='failed'?'err':'ice'); [cite: 455]
                if (state === 'failed' || state === 'disconnected') { needsRepair = true; updateButtons(); } [cite: 455]
                updateGlobalStatus(); [cite: 456]
            };
            voicePeerConnections[peerId] = { pc: pc, candidates: [] }; [cite: 457]
        }
        return voicePeerConnections[peerId]; [cite: 457]
    }

    async function handleVoiceMsg(msg) {
        const session = getVoicePC(msg.id); [cite: 458]
        const pc = session.pc; [cite: 459]

        try {
            if(msg.type === 'offer') { [cite: 459]
                if(pc.signalingState !== 'stable') return; [cite: 459]
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: msg.sdp })); [cite: 460]
                while(session.candidates.length) pc.addIceCandidate(session.candidates.shift()); [cite: 460]
                const answer = await pc.createAnswer(); [cite: 460]
                await pc.setLocalDescription(answer); [cite: 460]
                ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp, id: myId, targetId: msg.id })); [cite: 461]
            }
            else if(msg.type === 'answer') { [cite: 462]
                if(pc.signalingState !== 'have-local-offer') return; [cite: 462]
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: msg.sdp })); [cite: 463]
                while(session.candidates.length) pc.addIceCandidate(session.candidates.shift()); [cite: 463]
            }
            else if(msg.type === 'candidate') { [cite: 464]
                const ip = msg.candidate.split(' ')[4]; [cite: 464]
                if(ip.includes(':')) return; [cite: 465]
                if(pc.remoteDescription) pc.addIceCandidate(msg); [cite: 465]
                else session.candidates.push(msg); [cite: 465]
            }
        } catch(e) { log(e.message, "err"); } [cite: 466]
    }

    function handleRoster(roster) {
        currentRoster = roster; [cite: 467]
        renderRoster(); [cite: 467]
        const host = roster.find(u => u.isBroadcasting); [cite: 467]
        if(host) broadcasterId = host.id; [cite: 468]

        roster.forEach(peer => {
            if(peer.id === myId || peer.id === broadcasterId) return; [cite: 468]
            if(myId < peer.id && !voicePeerConnections[peer.id] && !initializingPeers.has(peer.id)) { [cite: 468]
                initializingPeers.add(peer.id); [cite: 468]
                setTimeout(() => {
                    const session = getVoicePC(peer.id); [cite: 469]
                    session.pc.createOffer().then(offer => { [cite: 469]
                        session.pc.setLocalDescription(offer); [cite: 469]
                        ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp, id: myId, targetId: peer.id })); [cite: 469]
                    });
                }, 1500 + Math.random()*1000); [cite: 470]
            }
        });
    }

    function renderRoster() {
        const list = document.getElementById('roster-list'); [cite: 471]
        list.innerHTML = ''; [cite: 472]
        currentRoster.forEach(u => {
            const isMe = u.id === myId; [cite: 472]
            const isSender = u.isBroadcasting; [cite: 472]
            
            let roleIcon = ''; [cite: 475]
            if (isSender) {
                roleIcon = `<div class="role-icon sender">${ICON_MIC}</div>`; [cite: 475]
            } else {
                const muteClass = (u.isMicEnabled !== false && u.isMusicEnabled !== false) ? 'recv-unmuted' : 'recv-muted'; [cite: 477]
                roleIcon = `<div class="role-icon ${muteClass}">${ICON_HEADPHONES}</div>`; [cite: 477]
            }

            const isActive = isSender ? u.isMusicEnabled : (u.isMicEnabled !== false); [cite: 478]
            const rightClass = isActive ? 'roster-status unmuted' : 'roster-status muted'; [cite: 478]
            
            const el = document.createElement('div'); [cite: 478]
            el.className = 'roster-item'; [cite: 479]
            el.innerHTML = `
                <div class="roster-left">
                    ${roleIcon}
                    <span class="roster-name">${isMe ? u.name + ' (You)' : u.name}</span>
                </div>
                <div id="status-icon-${u.id}" class="${rightClass}">${ICON_MIC}</div>
            `;
            list.appendChild(el); [cite: 481]
        });
    }
    
    function updateGlobalStatus() {
        const studioActive = studioPC && (studioPC.iceConnectionState === 'connected' || studioPC.iceConnectionState === 'completed'); [cite: 486]
        const voiceActive = Object.values(voicePeerConnections).some(v => v.pc.iceConnectionState === 'connected');

        if (studioActive || voiceActive) { [cite: 485]
            if (!isConnected) log("Audio Link Active: LIVE", "success"); [cite: 484]
            statusText.innerText = "LIVE AUDIO"; [cite: 485]
            statusDot.className = "status-dot on"; [cite: 501]
            isConnected = true;
        } else {
            statusText.innerText = ws && ws.readyState === 1 ? "WAITING FOR SOURCE" : "DISCONNECTED"; [cite: 502]
            statusDot.className = "status-dot"; [cite: 503]
            isConnected = false;
        }
    }

    async function handleStudioMsg(msg) {
        if(msg.type === 'offer') { [cite: 482]
            if(studioPC) studioPC.close(); [cite: 482]
            studioPC = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }); [cite: 483]
            studioPC.ontrack = e => { [cite: 484]
                log("ðŸŽµ Studio Stream Active", "success"); [cite: 484]
                audioEl.srcObject = e.streams[0]; [cite: 485]
                startVisuals(e.streams[0]); [cite: 485]
                startStats(studioPC); [cite: 485]
            };
            studioPC.onconnectionstatechange = () => { [cite: 485]
                updateGlobalStatus(); [cite: 486]
            };
            await studioPC.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: msg.sdp })); [cite: 486]
            const answer = await studioPC.createAnswer(); [cite: 487]
            answer.sdp = answer.sdp.replace("useinbandfec=1", "useinbandfec=1;stereo=1;sprop-stereo=1;maxaveragebitrate=510000;cbr=1;x-google-min-bitrate=510"); [cite: 487]
            await studioPC.setLocalDescription(answer); [cite: 487]
            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp, id: myId, targetId: msg.id })); [cite: 488]
        } else if(msg.type === 'candidate' && studioPC) { [cite: 489]
            studioPC.addIceCandidate(msg); [cite: 489]
        }
    }

    function startVisuals(stream) {
        if (audioCtx.state === 'suspended') audioCtx.resume(); [cite: 490]
        try {
            const src = audioCtx.createMediaStreamSource(stream.clone()); [cite: 491]
            analyser = audioCtx.createAnalyser(); [cite: 491]
            analyser.fftSize = 256; [cite: 492]
            src.connect(analyser); [cite: 492]
            draw(); [cite: 492]
        } catch(e){}
    }
    function draw() {
        if(!analyser) return; [cite: 492]
        const d = new Uint8Array(analyser.frequencyBinCount); [cite: 493]
        analyser.getByteFrequencyData(d); [cite: 493]
        let s=0; for(let i=0;i<d.length;i++)s+=d[i]; [cite: 493]
        const p = Math.min(100, (s/d.length/50)*100); [cite: 493]
        document.getElementById('m-l').style.height = p+"%"; [cite: 493]
        document.getElementById('m-r').style.height = p+"%"; [cite: 494]
        requestAnimationFrame(draw); [cite: 494]
    }
    function startStats(pc) {
        clearInterval(statsInterval); [cite: 494]
        let prevBytes=0, prevTime=Date.now(); [cite: 495]
        statsInterval = setInterval(async()=>{ [cite: 495]
            if(!pc || pc.iceConnectionState!=='connected') return; [cite: 495]
            const stats = await pc.getStats(); [cite: 495]
            stats.forEach(r=>{ [cite: 495]
                if(r.type==='inbound-rtp' && r.kind=='audio') { [cite: 495]
                    const now=Date.now(); const b=r.bytesReceived; [cite: 496]
                    if(prevBytes>0) { [cite: 496]
                        const kbps = ((b-prevBytes)*8)/(now-prevTime); [cite: 496]
                        const txt = kbps > 64 ? `${kbps.toFixed(0)} kbps` : `Idle (${kbps.toFixed(0)} kbps)`; [cite: 496]
                        document.getElementById('bitrate').innerText = txt; [cite: 497]
                    }
                    prevBytes=b; prevTime=now; [cite: 497]
                }
            });
        }, 1000); [cite: 498]
    }
    function broadcastStatus() {
        if(ws && ws.readyState===1) ws.send(JSON.stringify({ type:'status-update', id:myId, isMicEnabled:isTalking, isMusicEnabled:!isMuted })); [cite: 498]
    }
    function setUIState(s) {
        const p=document.getElementById('setup-panel'), m=document.getElementById('mini-meters'), r=document.getElementById('roster-panel'), ti=document.getElementById('btn-talk'); [cite: 499]
        if(s==='connecting') { btnMain.innerText="Connecting..."; btnMain.disabled=true; p.style.opacity="0.5"; } [cite: 500]
        else if (s==='connected') { isConnected=true; btnMain.innerText="Disconnect"; btnMain.className="disconnect"; [cite: 500]
            btnMain.disabled=false; statusText.innerText="LIVE AUDIO"; statusDot.className="status-dot on"; p.style.display="none"; m.style.display="flex"; r.style.display="flex"; if(localVoiceStream) ti.style.display="flex"; btnMute.style.display="flex"; broadcastStatus(); [cite: 501]
        }
        else { isConnected=false; btnMain.innerText="Listen Live"; btnMain.className=""; btnMain.disabled=false; statusText.innerText="DISCONNECTED"; statusDot.className="status-dot"; p.style.display="flex"; p.style.opacity="1"; m.style.display="none"; [cite: 502]
            r.style.display="none"; ti.style.display="none"; btnMute.style.display="none"; } [cite: 503]
    }
    btnMute.addEventListener('click', () => { isMuted = !isMuted; audioEl.muted = isMuted; document.querySelectorAll('#voice-container audio').forEach(a => a.muted = isMuted); updateButtons(); broadcastStatus(); }); [cite: 503]

    setInterval(updateGlobalStatus, 2000);
</script>
</body>
</html>
